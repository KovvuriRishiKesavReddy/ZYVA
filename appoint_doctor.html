<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ZYVA - Book Doctor Appointment</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 50%, #90CAF9 100%);
      min-height: 100vh;
      background-attachment: fixed;
    }
    .card-gradient {
      background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
      backdrop-filter: blur(10px);
    }
    footer {
      margin-top: auto;
      background: linear-gradient(135deg, #0369A1 0%, #0EA5E9 100%);
      color: white;
    }
    .nav-link.active {
      background: linear-gradient(to right, rgba(30, 136, 229, 0.1), rgba(66, 165, 245, 0.2));
      border-bottom: 3px solid #1976D2;
      font-weight: 600;
    }
  
    .time-slot {
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }
    .time-slot:hover {
      border-color: #3B82F6;
      background: rgba(59, 130, 246, 0.1);
    }
    .time-slot.selected {
      background: linear-gradient(135deg, #3B82F6, #1D4ED8);
      color: white;
      transform: scale(1.02);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    .time-slot.unavailable {
      background: #F3F4F6;
      color: #9CA3AF;
      cursor: not-allowed;
    }
    .time-slot.unavailable:hover {
      border-color: transparent;
      background: #F3F4F6;
    }
    .doctor-info-card {
      background: linear-gradient(135deg, #EBF8FF, #DBEAFE);
      border: 1px solid rgba(59, 130, 246, 0.2);
    }
    .booking-summary {
      background: linear-gradient(135deg, #F0FDF4, #DCFCE7);
      border: 1px solid rgba(34, 197, 94, 0.2);
    }
    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .animate-slide-up {
      animation: slideInUp 0.5s ease-out;
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="fixed top-0 left-0 w-full z-50 bg-white bg-opacity-90 shadow-md backdrop-blur-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16 items-center">
        <div class="flex items-center">
          <img src="logo.jpg" alt="ZYVA Logo" class="h-8 w-auto" />
          <span class="ml-2 text-xl font-semibold text-gray-800">ZYVA</span>
        </div>
        <div class="flex items-center space-x-4">
          <a href="doctor.html" class="px-3 py-2 text-sm font-medium text-blue-600 hover:text-blue-800 transition-colors">
            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            Back to Doctors
          </a>
          <a href="appointments.html" class="px-3 py-2 text-sm font-medium text-gray-800 hover:text-blue-600 transition-colors">My Appointments</a>
          <div class="relative">
            <div id="userMenuButton" class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center text-xs font-semibold cursor-pointer select-none" style="display: none;"></div>
            <div id="userMenu" class="hidden absolute right-0 mt-2 bg-white rounded-lg shadow-xl border border-gray-200 w-56 z-50">
                <div class="px-4 py-3 border-b border-gray-100">
                    <div id="menuName" class="text-sm font-semibold text-gray-800">Guest</div>
                    <div id="menuEmail" class="text-xs text-gray-500 truncate">guest@example.com</div>
                </div>
                <div class="py-1">
                    <a href="profile.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">Profile</a>
                    <a href="my_insurance.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">My Insurance</a>
                    <button id="logout-btn" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50">Log out</button>
                </div>
            </div>
        </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="min-h-screen px-4 pt-24 pb-10">
    <div class="max-w-4xl mx-auto">
      
      <!-- Page Header -->
      <div class="text-center mb-8 animate-slide-up">
        <h1 class="text-4xl font-bold text-gray-800 mb-2">Book Your Appointment</h1>
        <p class="text-gray-600">Select your preferred date and time slot</p>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- Left Column - Booking Form -->
        <div class="lg:col-span-2">
          
          <!-- Doctor Information Card -->
          <div id="doctor-info-card" class="doctor-info-card rounded-xl p-6 mb-8 shadow-lg animate-slide-up">
            <div class="flex items-center">
              <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center mr-4 shadow-lg">
                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
              </div>
              <div>
                <h2 id="doctor-name" class="text-2xl font-bold text-gray-800 mb-1">Loading...</h2>
                <p id="doctor-spec" class="text-blue-600 font-semibold mb-1">Loading...</p>
                <div class="flex items-center text-sm text-gray-600">
                  <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                  </svg>
                  <span id="doctor-location">Loading...</span>
                </div>
              </div>
              <div class="ml-auto text-right">
                <p class="text-sm text-gray-600">Consultation Fee</p>
                <p id="doctor-fee" class="text-2xl font-bold text-green-600">Loading...</p>
              </div>
            </div>
          </div>

          <!-- Date Selection -->
          <div class="card-gradient rounded-xl shadow-lg p-6 mb-6 animate-slide-up">
            <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
              <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
              Select Date
            </h3>
            <input 
              type="date" 
              id="appointment-date" 
              class="w-full border-2 border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 p-3 text-lg transition-all"
              min=""
            />
            <p class="text-sm text-gray-500 mt-2">Select a date within the next 30 days</p>
          </div>

          <!-- Time Slot Selection -->
          <div class="card-gradient rounded-xl shadow-lg p-6 animate-slide-up">
            <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
              <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              Available Time Slots
            </h3>
            
            <div id="time-slots-container">
              <p class="text-gray-500 text-center py-8">Please select a date first to view available time slots</p>
            </div>
          </div>
        </div>

        <!-- Right Column - Booking Summary -->
        <div class="lg:col-span-1">
          <div class="booking-summary rounded-xl shadow-lg p-6 sticky top-28 animate-slide-up">
            <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
              <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              Booking Summary
            </h3>
            
            <div class="space-y-4 mb-6">
              <div>
                <p class="text-sm text-gray-600">Doctor</p>
                <p id="summary-doctor" class="font-semibold text-gray-800">Not selected</p>
              </div>
              
              <div>
                <p class="text-sm text-gray-600">Specialization</p>
                <p id="summary-spec" class="font-semibold text-gray-800">-</p>
              </div>
              
              <div>
                <p class="text-sm text-gray-600">Date</p>
                <p id="summary-date" class="font-semibold text-gray-800">Not selected</p>
              </div>
              
              <div>
                <p class="text-sm text-gray-600">Time</p>
                <p id="summary-time" class="font-semibold text-gray-800">Not selected</p>
              </div>
              
              <hr class="border-gray-300">
              
              <div>
                <p class="text-sm text-gray-600">Consultation Fee</p>
                <p id="summary-fee" class="text-xl font-bold text-green-600">-</p>
              </div>
            </div>

            <button 
              id="confirm-appointment-btn" 
              class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white font-semibold py-3 px-4 rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all duration-200 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
              disabled
            >
              <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              Confirm & Proceed to Payment
            </button>
            
            <p class="text-xs text-gray-500 text-center mt-3">
              You will be redirected to the payment page to complete your booking
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 flex items-center">
      <svg class="animate-spin -ml-1 mr-3 h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <span class="text-gray-700 font-medium">Processing your booking...</span>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Get selected doctor from localStorage
      const selectedDoctor = JSON.parse(localStorage.getItem('selectedDoctor') || 'null');
      
      // Available time slots
      const timeSlots = [
        { time: '09:00', label: '09:00 AM', available: true },
        { time: '10:00', label: '10:00 AM', available: true },
        { time: '11:00', label: '11:00 AM', available: true },
        { time: '12:00', label: '12:00 PM', available: true },
        { time: '14:00', label: '02:00 PM', available: true },
        { time: '15:00', label: '03:00 PM', available: false }, // Example unavailable slot
        { time: '16:00', label: '04:00 PM', available: true },
        { time: '17:00', label: '05:00 PM', available: true }
      ];

      let selectedDate = '';
      let selectedTime = '';

      // Initialize the page
      init();

      function init() {
        if (!selectedDoctor) {
          showNotification('No doctor selected. Redirecting to doctors page...', 'error');
          setTimeout(() => {
            window.location.href = 'doctor.html';
          }, 2000);
          return;
        }

        displayDoctorInfo();
        setupDateInput();
        setupEventListeners();
      }

      function displayDoctorInfo() {
        // Populate doctor information
        document.getElementById('doctor-name').textContent = selectedDoctor.name;
        document.getElementById('doctor-spec').textContent = selectedDoctor.spec;
        document.getElementById('doctor-location').textContent = selectedDoctor.location || 'Hyderabad';
        document.getElementById('doctor-fee').textContent = selectedDoctor.fee;

        // Update summary
        document.getElementById('summary-doctor').textContent = selectedDoctor.name;
        document.getElementById('summary-spec').textContent = selectedDoctor.spec;
        document.getElementById('summary-fee').textContent = selectedDoctor.fee;
      }

      function setupDateInput() {
        const dateInput = document.getElementById('appointment-date');
        const today = new Date();
        const maxDate = new Date();
        maxDate.setDate(today.getDate() + 30);

        // Set minimum date to today
        dateInput.min = today.toISOString().split('T')[0];
        // Set maximum date to 30 days from now
        dateInput.max = maxDate.toISOString().split('T')[0];
      }

      function setupEventListeners() {
        // Date selection
        document.getElementById('appointment-date').addEventListener('change', (e) => {
          selectedDate = e.target.value;
          document.getElementById('summary-date').textContent = formatDate(selectedDate);
          generateTimeSlots();
          updateConfirmButton();
        });

        // Confirm appointment button
        document.getElementById('confirm-appointment-btn').addEventListener('click', confirmAppointment);
      }

      function generateTimeSlots() {
        const container = document.getElementById('time-slots-container');
        
        if (!selectedDate) {
          container.innerHTML = '<p class="text-gray-500 text-center py-8">Please select a date first</p>';
          return;
        }

        // Simulate some slots being unavailable based on date
        const selectedDateObj = new Date(selectedDate);
        const dayOfWeek = selectedDateObj.getDay();
        
        container.innerHTML = `
          <div class="grid grid-cols-2 gap-3">
            ${timeSlots.map(slot => {
              // Make some slots unavailable on weekends or randomly
              const isAvailable = slot.available && (dayOfWeek !== 0 && dayOfWeek !== 6) && Math.random() > 0.2;
              
              return `
                <button 
                  class="time-slot ${isAvailable ? '' : 'unavailable'} p-3 rounded-lg text-center font-medium transition-all"
                  data-time="${slot.time}"
                  data-label="${slot.label}"
                  ${!isAvailable ? 'disabled' : ''}
                >
                  ${slot.label}
                  ${!isAvailable ? '<br><span class="text-xs">Unavailable</span>' : ''}
                </button>
              `;
            }).join('')}
          </div>
        `;

        // Add click event listeners to time slots
        container.querySelectorAll('.time-slot:not(.unavailable)').forEach(slot => {
          slot.addEventListener('click', (e) => {
            // Remove previous selection
            container.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
            
            // Add selection to clicked slot
            e.target.classList.add('selected');
            
            selectedTime = e.target.dataset.time;
            const timeLabel = e.target.dataset.label;
            
            document.getElementById('summary-time').textContent = timeLabel;
            updateConfirmButton();
          });
        });
      }

      function updateConfirmButton() {
        const confirmBtn = document.getElementById('confirm-appointment-btn');
        
        if (selectedDate && selectedTime) {
          confirmBtn.disabled = false;
          confirmBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        } else {
          confirmBtn.disabled = true;
          confirmBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
      }

      function confirmAppointment() {
         if (!selectedDate || !selectedTime) {
           showNotification('Please select both date and time.', 'error');
           return;
         }
 
         // Show loading overlay
         document.getElementById('loading-overlay').classList.remove('hidden');
 
        // Prepare server payload
        const token = localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
        const currentUser = localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser');
        if (!token || !currentUser) {
          document.getElementById('loading-overlay').classList.add('hidden');
          showNotification('Please log in to book an appointment.', 'error');
          setTimeout(() => { window.location.href = 'login_page.html'; }, 1200);
          return;
        }

        const numericFee = Number(String(selectedDoctor.fee || '').replace(/[^0-9.]/g, '')) || 0;
        const payload = {
          type: 'doctor',
          items: {
            id: selectedDoctor.id,
            name: selectedDoctor.name,
            spec: selectedDoctor.spec,
            category: selectedDoctor.spec,
            fee: numericFee,
            price: numericFee,
            quantity: 1,
            location: selectedDoctor.location,
            rating: selectedDoctor.rating
          },
          date: selectedDate,
          time: selectedTime,
          location: selectedDoctor.location || 'Hyderabad'
        };

        fetch('http://localhost:3000/api/appointments', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(payload)
        })
        .then(async (res) => {
          const data = await res.json().catch(() => ({}));
          if (res.status === 401 || res.status === 403) {
            throw new Error('Session expired. Please login again.');
          }
          if (!res.ok || !data.success) {
            throw new Error(data.error || 'Failed to create appointment');
          }
          // Save minimal info locally for payment page
          const appointmentData = {
            appointmentId: data.appointmentId,
            doctorId: selectedDoctor.id,
            doctorName: selectedDoctor.name,
            doctorSpec: selectedDoctor.spec,
            doctorFee: selectedDoctor.fee,
            doctorLocation: selectedDoctor.location,
            date: selectedDate,
            time: selectedTime,
            timeLabel: document.getElementById('summary-time').textContent,
            status: 'pending',
            dateBooked: new Date().toISOString()
          };
          localStorage.setItem('pendingAppointment', JSON.stringify(appointmentData));
          // Redirect quickly to payment page
          document.getElementById('loading-overlay').classList.add('hidden');
          window.location.href = 'pay_doctor.html';
        })
        .catch((err) => {
          console.error('Appointment create error:', err);
          document.getElementById('loading-overlay').classList.add('hidden');
          showNotification(err.message || 'Failed to create appointment', 'error');
        });
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        const options = { 
          weekday: 'long', 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        };
        return date.toLocaleDateString('en-US', options);
      }

      function generateAppointmentId() {
        const timestamp = Date.now().toString().slice(-6);
        const random = Math.random().toString(36).substr(2, 4).toUpperCase();
        return `APT${timestamp}${random}`;
      }

      function showNotification(message, type = 'info') {
        // Remove existing notification
        const existing = document.querySelector('.notification');
        if (existing) existing.remove();

        const notification = document.createElement('div');
        notification.className = `notification fixed top-20 right-4 px-6 py-4 rounded-lg shadow-lg z-50 transform transition-all duration-300 ${
          type === 'success' ? 'bg-green-500 text-white' : 
          type === 'error' ? 'bg-red-500 text-white' : 
          'bg-blue-500 text-white'
        }`;
        
        notification.innerHTML = `
          <div class="flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              ${type === 'success' ? 
                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>' :
                type === 'error' ?
                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>' :
                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>'
              }
            </svg>
            <span>${message}</span>
          </div>
        `;

        document.body.appendChild(notification);

        // Auto remove
        setTimeout(() => {
          notification.style.transform = 'translateX(100%)';
          notification.style.opacity = '0';
          setTimeout(() => notification.remove(), 300);
        }, 4000);
      }
    });
  </script>
  <script src="auth.js"></script>
  <footer class="py-6 flex-grow bottom-0 left-0 w-full"> <div class="text-center text-sm">© 2025 ZYVA Healthcare. All rights reserved to ZYVA.</div> </footer>
</body>
</html>