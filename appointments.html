<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ZYVA - Appointments</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 50%, #90CAF9 100%);
            min-height: 100vh;
            background-attachment: fixed;
        }
        .card-gradient {
            background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%);
        }
        #filter-container {
            margin-top: 72px;
            max-width: 7xl;
            margin-left: auto;
            margin-right: auto;
            padding-left: 1rem;
            padding-right: 1rem;
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            background-color: rgba(255 255 255 / 0.85);
            box-shadow: 0 1px 3px rgb(0 0 0 / 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
        }
        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        #filter-container label {
            font-weight: 600;
            color: #1e40af;
        }
        #limit-select, #type-filter {
            padding: 0.2rem 0.5rem;
            border: 1px solid #93c5fd;
            border-radius: 0.375rem;
            font-size: 1rem;
            font-weight: 600;
            color: #1e40af;
            background-color: white;
            cursor: pointer;
        }
        .nav-link.active {
            background: linear-gradient(to right, rgba(30, 136, 229, 0.1), rgba(66, 165, 245, 0.2));
            border-bottom: 3px solid #1976D2;
            font-weight: 600;
        }
        footer {
      margin-top: auto;
      background: linear-gradient(135deg, #0369A1 0%, #0EA5E9 100%);
      color: white;
        }
        .order-status {
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-pending { background-color: #fef3c7; color: #92400e; }
        .status-confirmed { background-color: #dbeafe; color: #1e40af; }
        .status-completed { background-color: #dcfce7; color: #166534; }
        .status-cancelled { background-color: #fee2e2; color: #dc2626; }
        .appointment-scan {
            border-left: 4px solid #10b981;
        }
        .appointment-doctor {
            border-left: 4px solid #3b82f6;
        }
        .appointment-type-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }
        .badge-scan {
            background-color: #d1fae5;
            color: #065f46;
        }
        .badge-doctor {
            background-color: #dbeafe;
            color: #1e3a8a;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="fixed top-0 left-0 w-full z-50 bg-white bg-opacity-90 shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center">
                    <img src="logo.jpg" alt="ZYVA Logo" class="h-8 w-auto" />
                    <span class="ml-2 text-xl font-semibold text-gray-800">ZYVA</span>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="home_page.html" class="px-3 py-2 text-sm font-medium text-gray-800 hover:text-yellow-700">Home</a>
                    <a href="medicine.html" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-800">Medicines</a>
                    <div class="relative group">
                        <a href="doctor.html" class="px-3 py-2 text-sm font-medium text-gray-800 hover:text-yellow-700">Doctors</a>
                    </div>
                    <a href="scans.html" class="px-3 py-2 text-sm font-medium text-gray-800 hover:text-yellow-700">Scans</a>
                    <a href="orders.html" class="px-3 py-2 text-sm font-medium text-gray-800 hover:text-yellow-700">Orders</a>
                    <a href="appointments.html" class="nav-link active px-3 py-2 rounded-md text-sm font-medium text-gray-800">Appointments</a>
                    <a href="reminder.html" class="px-3 py-2 text-sm font-medium text-gray-800 hover:text-yellow-700">Reminders</a>
                    <div class="relative group">
                        <a href="#" class="px-3 py-2 text-sm font-medium text-gray-800 hover:text-yellow-700">My Health</a>
                        <div class="hidden absolute right-0 mt-2 bg-white rounded-lg shadow-xl border border-gray-200 w-56 z-50 group-hover:block">
                            <a href="prescriptions.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">Prescriptions</a>
                            <a href="symptom_checker.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">Symptom Checker</a>
                            <a href="blood_analysis.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">Blood Analysis</a>
                            <a href="sugar.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">Blood Sugar Analysis</a>
                        </div>
                    </div>
                    <a href="insurance.html" class="px-3 py-2 text-sm font-medium text-gray-800 hover:text-yellow-700">Insurance</a>
                    <div class="relative">
                        <div id="userMenuButton" class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center text-xs font-semibold cursor-pointer select-none" style="display: none;"></div>
                        <div id="userMenu" class="hidden absolute right-0 mt-2 bg-white rounded-lg shadow-xl border border-gray-200 w-56 z-50">
                            <div class="px-4 py-3 border-b border-gray-100">
                                <div id="menuName" class="text-sm font-semibold text-gray-800">Guest</div>
                                <div id="menuEmail" class="text-xs text-gray-500 truncate">guest@example.com</div>
                            </div>
                            <div class="py-1">
                                <a href="profile.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">Profile</a>
                                <a href="my_insurance.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">My Insurance</a>
                                <button id="logout-btn" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50">Log out</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Filter Controls below navbar -->
    <div id="filter-container">
        <div class="filter-group">
            <label for="type-filter">Show:</label>
            <select id="type-filter" aria-label="Filter appointment types">
                <option value="all" selected>All Appointments</option>
                <option value="scan">Scans Only</option>
                <option value="doctor">Doctors Only</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="limit-select">Show recent:</label>
            <select id="limit-select" aria-label="Select number of recent appointments">
                <option value="3" selected>3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="15">15</option>
                <option value="all">All</option>
            </select>
        </div>
    </div>

    <!-- Appointments Section -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="card-gradient rounded-lg shadow-xl p-6 mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Your Appointments</h1>
            <div id="appointments-container">
                <!-- Appointments will be dynamically inserted here -->
            </div>
        </div>
    </div>
    <div id="empty-state" class="text-center py-12" style="display: none;">
      <svg class="w-24 h-24 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
      </svg>
      <h3 class="text-xl font-semibold text-gray-600 mb-2">No Appointments found</h3>
      <p class="text-gray-500 mb-6">You haven't got any appointments yet.</p>
      <a href="doctor.html" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
          </svg>
          Book an Appointment
      </a>
  </div>

    <footer class="py-6 flex-grow bottom-0 left-0 w-full">
        <div class="text-center text-sm">Â© 2025 ZYVA Healthcare. All rights reserved to ZYVA.</div>
    </footer>

    <script>
        const appointmentsContainer = document.getElementById('appointments-container');
        const limitSelect = document.getElementById('limit-select');
        const typeFilter = document.getElementById('type-filter');

        function getAuthToken() { return localStorage.getItem('authToken') || sessionStorage.getItem('authToken'); }
        function getCurrentUser() { const u = localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser'); return u ? JSON.parse(u) : null; }
        function ensureLoggedIn() { const t = getAuthToken(); const u = getCurrentUser(); if (!t || !u) { appointmentsContainer.innerHTML = '<div class="text-center py-8 text-gray-600">Please log in to view your appointments.</div>'; return false; } return true; }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try { return new Date(dateString).toLocaleString(); } catch { return dateString; }
        }

        function formatDateOnly(dateString) {
            if (!dateString) return 'N/A';
            try {
                const d = new Date(dateString);
                return new Intl.DateTimeFormat('en-IN', { year: 'numeric', month: 'short', day: 'numeric' }).format(d);
            } catch { return dateString; }
        }

        function renderAppointments(allAppointments, limit, type) {
            let filtered = allAppointments;
            if (type === 'scan') filtered = filtered.filter(a => a.type === 'scan');
            if (type === 'doctor') filtered = filtered.filter(a => a.type === 'doctor');

            filtered.sort((a, b) => new Date(b.createdAt || b.dateBooked) - new Date(a.createdAt || a.dateBooked));
            if (limit !== 'all') filtered = filtered.slice(0, Number(limit));

            if (filtered.length === 0) {
                appointmentsContainer.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-gray-500 text-lg mb-4">No appointments found.</p>
                        <p class="text-sm text-gray-400">${type === 'all' ? 'Book a scan or doctor appointment to see them here.' : (type === 'scan' ? 'Book a scan appointment to see it here.' : 'Book a doctor appointment to see it here.')}</p>
                    </div>`;
                return;
            }

            appointmentsContainer.innerHTML = '';
            filtered.forEach((item) => {
                const isDoctor = (String(item.type || '').toLowerCase() === 'doctor') || (!!item.items && !Array.isArray(item.items) && (item.items.name || item.items.spec));
                const status = String(item.status || 'pending').toLowerCase();
                const statusClass = `status-${status}`;
                const card = document.createElement('div');
                card.className = 'order-card p-6 border border-gray-200 rounded-lg mb-4 bg-white bg-opacity-90 shadow-sm';

                if (isDoctor) {
                    const docItem = (!Array.isArray(item.items) && item.items) ? item.items : (Array.isArray(item.items) ? item.items[0] : {});
                    const rawFee = (docItem && (docItem.price ?? docItem.fee)) ?? 0;
                    const docFee = typeof rawFee === 'number' ? rawFee : Number(String(rawFee).replace(/[^0-9.]/g, '')) || 0;
                    const hasPrices = docFee > 0;
                    const platformFeeDoc = hasPrices ? 50 : 0;
                    const gstAmountDoc = Math.round((docFee + platformFeeDoc) * 0.18);
                    const totalAmountDoc = docFee + platformFeeDoc + gstAmountDoc;
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                          <div>
                            <h2 class="text-xl font-semibold text-gray-800 mb-1">Appointment #${item.appointmentId || 'â'}</h2>
                            <p class="text-sm text-gray-500">Booked on ${formatDate(item.createdAt)}</p>
                          </div>
                          <div class="text-right">
                            <span class="order-status ${statusClass}">${status}</span>
                            ${hasPrices ? `<p class=\"text-lg font-bold text-green-600 mt-1\">â¹${totalAmountDoc}</p>` : ''}
                          </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-2">
                          <div>
                            <p class="text-xs text-gray-500 uppercase tracking-wide">Doctor</p>
                            <p class="text-sm text-gray-700">${docItem?.name || 'Doctor'}</p>
                          </div>
                          <div>
                            <p class="text-xs text-gray-500 uppercase tracking-wide">Specialization</p>
                            <p class="text-sm text-gray-700">${docItem?.spec || 'N/A'}</p>
                          </div>
                          <div>
                            <p class="text-xs text-gray-500 uppercase tracking-wide">Schedule</p>
                            <p class="text-sm text-gray-700">${item.schedule?.time || ''} ${item.schedule?.date ? 'â¢ ' + formatDateOnly(item.schedule.date) : ''}</p>
                          </div>
                          <div>
                            <p class="text-xs text-gray-500 uppercase tracking-wide">Location</p>
                            <p class="text-sm text-gray-700">${docItem?.location || item.schedule?.location || 'N/A'}</p>
                          </div>
                        </div>
                        <div class="border-t pt-4 mt-2">
                          <h3 class="text-sm font-semibold text-gray-700 mb-3">Appointment Items:</h3>
                          <div class="space-y-2">
                            <div class=\"flex justify-between items-center py-2 px-3 bg-gray-50 rounded\">
                              <div class=\"flex-1\">
                                <p class=\"text-sm font-medium text-gray-800\">${docItem?.name || 'Doctor'}</p>
                                ${docItem?.spec ? `<p class=\\"text-xs text-gray-500\\">${docItem.spec}</p>` : ''}
                              </div>
                              <div class=\"text-right\">
                                ${hasPrices ? `<p class=\\"text-sm font-semibold text-gray-800\\">â¹${docFee.toFixed(2)}</p>` : ''}
                              </div>
                            </div>
                          </div>
                        </div>
                        ${hasPrices ? `
                          <div class=\"border-t pt-4 mt-4\">
                            <div class=\"bg-gray-50 rounded p-3\">
                              <div class=\"grid grid-cols-2 gap-2 text-sm\">
                                <div class=\"flex justify-between\"><span class=\"text-gray-600\">Consultation Fee:</span><span>â¹${docFee.toFixed(2)}</span></div>
                                <div class=\"flex justify-between\"><span class=\"text-gray-600\">Platform Fee:</span><span>â¹${platformFeeDoc}</span></div>
                                <div class=\"flex justify-between\"><span class=\"text-gray-600\">GST (18%):</span><span>â¹${gstAmountDoc}</span></div>
                                <div class=\"flex justify-between font-semibold\"><span class=\"text-gray-800\">Total:</span><span class=\"text-green-600\">â¹${totalAmountDoc}</span></div>
                              </div>
                            </div>
                          </div>
                        ` : ''}
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mt-4">
                      
                        </div>`;
                } else {
                    const firstScan = Array.isArray(item.items) ? item.items[0] : item.items;
                    // Calculate totals if prices present
                    const scans = Array.isArray(item.items) ? item.items : (item.items ? [item.items] : []);
                    const cartTotal = scans.reduce((sum, it) => sum + (Number(it.price || 0) * (Number(it.quantity || 1))), 0);
                    const platformFee = scans.length > 0 ? 50 : 0;
                    const gstAmount = Math.round((cartTotal + platformFee) * 0.18);
                    const totalAmount = cartTotal + platformFee + gstAmount;
                    const hasPrices = cartTotal > 0;

                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                          <div>
                            <h2 class="text-xl font-semibold text-gray-800 mb-1">Appointment #${item.appointmentId || 'â'}</h2>
                            <p class="text-sm text-gray-500">Booked on ${formatDate(item.createdAt)}</p>
                          </div>
                          <div class="text-right">
                            <span class="order-status ${statusClass}">${status}</span>
                            ${hasPrices ? `<p class=\"text-lg font-bold text-green-600 mt-1\">â¹${totalAmount}</p>` : ''}
                          </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-2">
                          <div>
                            <p class="text-xs text-gray-500 uppercase tracking-wide">Scan</p>
                            <p class="text-sm text-gray-700">${firstScan?.scanName || firstScan?.name || 'Scan'}</p>
                          </div>
                          <div>
                            <p class="text-xs text-gray-500 uppercase tracking-wide">Category</p>
                            <p class="text-sm text-gray-700">${firstScan?.category || firstScan?.type || 'N/A'}</p>
                          </div>
                          <div>
                            <p class="text-xs text-gray-500 uppercase tracking-wide">Schedule</p>
                            <p class="text-sm text-gray-700">${item.schedule?.time || ''} ${item.schedule?.date ? 'â¢ ' + formatDateOnly(item.schedule.date) : ''}</p>
                          </div>
                          <div>
                            <p class="text-xs text-gray-500 uppercase tracking-wide">Location</p>
                            <p class="text-sm text-gray-700">${item.schedule?.location || 'N/A'}</p>
                          </div>
                        </div>
                        ${scans.length > 0 ? `
                          <div class="border-t pt-4 mt-2">
                            <h3 class="text-sm font-semibold text-gray-700 mb-3">Appointment Items:</h3>
                            <div class="space-y-2">
                              ${scans.map(s => `
                                <div class=\"flex justify-between items-center py-2 px-3 bg-gray-50 rounded\">
                                  <div class=\"flex-1\">
                                    <p class=\"text-sm font-medium text-gray-800\">${s.scanName || s.name || 'Scan'}</p>
                                    ${s.category ? `<p class=\\"text-xs text-gray-500\\">${s.category}</p>` : ''}
                                  </div>
                                  <div class=\"text-right\">
                                    ${s.price ? `<p class=\\"text-sm text-gray-600\\">Qty: ${s.quantity || 1}</p>` : ''}
                                    ${s.price ? `<p class=\\"text-sm font-semibold text-gray-800\\">â¹${(Number(s.price) * (Number(s.quantity || 1))).toFixed(2)}</p>` : ''}
                                  </div>
                                </div>
                              `).join('')}
                            </div>
                          </div>
                        ` : ''}
                        ${hasPrices ? `
                          <div class=\"border-t pt-4 mt-4\">
                            <div class=\"bg-gray-50 rounded p-3\">
                              <div class=\"grid grid-cols-2 gap-2 text-sm\">
                                <div class=\"flex justify-between\"><span class=\"text-gray-600\">Cart Total:</span><span>â¹${cartTotal.toFixed(2)}</span></div>
                                <div class=\"flex justify-between\"><span class=\"text-gray-600\">Platform Fee:</span><span>â¹${platformFee}</span></div>
                                <div class=\"flex justify-between\"><span class=\"text-gray-600\">GST (18%):</span><span>â¹${gstAmount}</span></div>
                                <div class=\"flex justify-between font-semibold\"><span class=\"text-gray-800\">Total:</span><span class=\"text-green-600\">â¹${totalAmount}</span></div>
                              </div>
                            </div>
                          </div>
                        ` : ''}
                        `;
                }

                appointmentsContainer.appendChild(card);
            });
        }

        async function loadAppointments() {
            if (!ensureLoggedIn()) return;
            try {
                const token = getAuthToken();
                const res = await fetch('http://localhost:3000/api/appointments/user', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.status === 401 || res.status === 403) { window.location.href = 'login_page.html'; return; }
                
                if (!res.ok) {
                    const contentType = res.headers.get('content-type');
                    let error;
                    if (contentType && contentType.includes('application/json')) {
                        const errorData = await res.json();
                        error = new Error(errorData.error || `HTTP error! status: ${res.status}`);
                    } else {
                        const errorText = await res.text();
                        error = new Error(`Server responded with ${res.status}: ${errorText.substring(0, 100)}`);
                    }
                    throw error;
                }

                const data = await res.json();
                const items = data.success ? data.appointments : [];
                renderAppointments(items, limitSelect.value, typeFilter.value);
            } catch (e) {
                console.error('Failed to load appointments', e);
                appointmentsContainer.innerHTML = '<div class="text-center py-8 text-red-600">Failed to load appointments. Please try again.</div>';
            }
        }

        limitSelect.addEventListener('change', loadAppointments);
        typeFilter.addEventListener('change', loadAppointments);
        window.addEventListener('storage', (e) => { if (e.key === 'authToken' || e.key === 'currentUser') loadAppointments(); });
        window.onload = loadAppointments;
    </script>
    <script src="auth.js"></script>
    
</body>
</html>