<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ZYVA - Insurance Payment</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 50%, #90CAF9 100%);
            min-height: 100vh;
            background-attachment: fixed;
        }
        .card-gradient {
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
            backdrop-filter: blur(10px);
        }
        footer {
            margin-top: auto;
            background: linear-gradient(135deg, #0369A1 0%, #0EA5E9 100%);
            color: white;
        }
        .payment-method-card {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .payment-method-card:hover {
            border-color: #3B82F6;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
        }
        .payment-method-card.selected {
            border-color: #3B82F6;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 197, 253, 0.1));
            transform: translateY(-2px);
        }
        .amount-card {
            background: linear-gradient(135deg, #F0FDF4, #DCFCE7);
            border: 1px solid rgba(34, 197, 94, 0.2);
        }
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-slide-up {
            animation: slideInUp 0.5s ease-out;
        }
        .payment-form-section {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .payment-form-section.active {
            max-height: 500px;
        }
        .secure-badge {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="fixed top-0 left-0 w-full z-50 bg-white bg-opacity-90 shadow-md backdrop-blur-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center">
                    <img src="logo.jpg" alt="ZYVA Logo" class="h-8 w-auto" />
                    <span class="ml-2 text-xl font-semibold text-gray-800">ZYVA</span>
                </div>
                <div class="flex items-center space-x-4">
                     <a href="insurance.html" class="px-3 py-2 text-sm font-medium text-blue-600 hover:text-blue-800 transition-colors">
                         <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                         </svg>
                         Back to Plans
                     </a>
                     <div class="relative">
                         <div id="userMenuButton" class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center text-xs font-semibold cursor-pointer select-none" style="display: none;"></div>
                         <div id="userMenu" class="hidden absolute right-0 mt-2 bg-white rounded-lg shadow-xl border border-gray-200 w-56 z-50">
                             <div class="px-4 py-3 border-b border-gray-100">
                                 <div id="menuName" class="text-sm font-semibold text-gray-800">Guest</div>
                                 <div id="menuEmail" class="text-xs text-gray-500 truncate">guest@example.com</div>
                             </div>
                             <div class="py-1">
                                 <a href="profile.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">Profile</a>
                                 <a href="my_insurance.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">My Insurance</a>
                                 <button id="logout-btn" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50">Log out</button>
                             </div>
                         </div>
                     </div>
                 </div>
            </div>
        </div>
    </nav>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="bg-white p-6 rounded-lg shadow-lg text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-gray-700">Processing your payment...</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="min-h-screen px-4 pt-24 pb-10">
        <div class="max-w-5xl mx-auto">
            
            <!-- Page Header -->
            <div class="text-center mb-8 animate-slide-up">
                <h1 class="text-4xl font-bold text-gray-800 mb-2">Complete Your Payment</h1>
                <p class="text-gray-600">Secure payment for your insurance plan</p>
                <div class="flex items-center justify-center mt-3">
                    <div class="secure-badge px-3 py-1 rounded-full text-sm font-medium flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                        </svg>
                        SSL Secured Payment
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <!-- Left Column - Payment Form -->
                <div class="lg:col-span-2">
                    
                    <!-- Payment Methods -->
                    <div class="card-gradient rounded-xl shadow-lg p-6 mb-6 animate-slide-up">
                        <h3 class="text-xl font-semibold text-gray-800 mb-6 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                            </svg>
                            Choose Payment Method
                        </h3>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                            <div class="payment-method-card bg-white rounded-lg p-4 cursor-pointer selected" data-method="card">
                                <div class="flex items-center">
                                    <input type="radio" name="paymentMethod" value="card" class="form-radio text-blue-600 mr-3" checked />
                                    <div>
                                        <p class="font-semibold text-gray-800">Credit/Debit Card</p>
                                        <p class="text-sm text-gray-500">Visa, MasterCard, Rupay</p>
                                    </div>
                                    <div class="ml-auto">
                                        <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>

                            <div class="payment-method-card bg-white rounded-lg p-4 cursor-pointer" data-method="upi">
                                <div class="flex items-center">
                                    <input type="radio" name="paymentMethod" value="upi" class="form-radio text-blue-600 mr-3" />
                                    <div>
                                        <p class="font-semibold text-gray-800">UPI Payment</p>
                                        <p class="text-sm text-gray-500">Google Pay, PhonePe, Paytm</p>
                                    </div>
                                    <div class="ml-auto">
                                        <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>

                            <div class="payment-method-card bg-white rounded-lg p-4 cursor-pointer" data-method="netbanking">
                                <div class="flex items-center">
                                    <input type="radio" name="paymentMethod" value="netbanking" class="form-radio text-blue-600 mr-3" />
                                    <div>
                                        <p class="font-semibold text-gray-800">Net Banking</p>
                                        <p class="text-sm text-gray-500">All major banks supported</p>
                                    </div>
                                    <div class="ml-auto">
                                        <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>

                            <div class="payment-method-card bg-white rounded-lg p-4 cursor-pointer" data-method="wallet">
                                <div class="flex items-center">
                                    <input type="radio" name="paymentMethod" value="wallet" class="form-radio text-blue-600 mr-3" />
                                    <div>
                                        <p class="font-semibold text-gray-800">Digital Wallet</p>
                                        <p class="text-sm text-gray-500">Paytm, Amazon Pay, etc.</p>
                                    </div>
                                    <div class="ml-auto">
                                        <svg class="w-8 h-8 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Form Sections -->
                        <form id="payment-form">
                            <!-- Personal Details -->
                            <div class="mb-6">
                                <h4 class="text-lg font-semibold text-gray-800 mb-4">Personal Information</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Full Name *</label>
                                        <input type="text" id="user-name" class="w-full border-2 border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" required />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Email Address *</label>
                                        <input type="email" id="user-email" class="w-full border-2 border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" required placeholder="you@example.com" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number *</label>
                                        <input type="tel" id="user-phone" class="w-full border-2 border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" required placeholder="+91 12345 67890" />
                                    </div>
                                    
                                </div>
                            </div>

                            <!-- Card Details -->
                            <div id="card-details" class="payment-form-section active mb-6">
                                <h4 class="text-lg font-semibold text-gray-800 mb-4">Card Details</h4>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Card Number *</label>
                                        <input type="text" id="card-number" maxlength="19" placeholder="1234 5678 9012 3456" class="w-full border-2 border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" />
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Expiry Date *</label>
                                            <input type="text" id="card-expiry" maxlength="5" placeholder="MM/YY" class="w-full border-2 border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" />
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">CVV *</label>
                                            <input type="password" id="card-cvv" maxlength="4" placeholder="123" class="w-full border-2 border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" />
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cardholder Name *</label>
                                        <input type="text" id="card-name" placeholder="Name as on card" class="w-full border-2 border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" />
                                    </div>
                                </div>
                            </div>

                            <!-- UPI Details -->
                            <div id="upi-details" class="payment-form-section mb-6">
                                <h4 class="text-lg font-semibold text-gray-800 mb-4">UPI Details</h4>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">UPI ID *</label>
                                    <input type="text" id="upi-id" placeholder="example@paytm" class="w-full border-2 border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" />
                                </div>
                            </div>

                            <!-- Net Banking Details -->
                            <div id="netbanking-details" class="payment-form-section mb-6">
                                <h4 class="text-lg font-semibold text-gray-800 mb-4">Select Your Bank</h4>
                                <select id="bank-select" class="w-full border-2 border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                                    <option value="">Choose your bank</option>
                                    <option value="sbi">State Bank of India</option>
                                    <option value="hdfc">HDFC Bank</option>
                                    <option value="icici">ICICI Bank</option>
                                    <option value="axis">Axis Bank</option>
                                    <option value="pnb">Punjab National Bank</option>
                                    <option value="other">Other Banks</option>
                                </select>
                            </div>

                            <!-- Wallet Details -->
                            <div id="wallet-details" class="payment-form-section mb-6">
                                <h4 class="text-lg font-semibold text-gray-800 mb-4">Select Wallet</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <label class="flex items-center p-3 border-2 border-gray-300 rounded-lg cursor-pointer hover:border-blue-500">
                                        <input type="radio" name="wallet-type" value="paytm" class="form-radio text-blue-600 mr-3" />
                                        <span>Paytm</span>
                                    </label>
                                    <label class="flex items-center p-3 border-2 border-gray-300 rounded-lg cursor-pointer hover:border-blue-500">
                                        <input type="radio" name="wallet-type" value="amazonpay" class="form-radio text-blue-600 mr-3" />
                                        <span>Amazon Pay</span>
                                    </label>
                                </div>
                            </div>

                            <button type="submit" id="pay-now-btn" class="w-full bg-gradient-to-r from-green-600 to-green-700 text-white font-bold py-4 px-6 rounded-lg hover:from-green-700 hover:to-green-800 transition-all duration-200 transform hover:scale-105 shadow-lg">
                                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                </svg>
                                Pay Now - <span id="pay-amount">₹0</span>
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Right Column - Order Summary & Payment Summary -->
                <div class="lg:col-span-1 space-y-6">
                    
                    <!-- Order Summary -->
                    <div class="card-gradient rounded-xl shadow-lg p-6 animate-slide-up">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                            </svg>
                            Plan Summary
                        </h3>
                        
                        <div id="order-items-list" class="space-y-3 mb-4 max-h-60 overflow-y-auto">
                            <!-- Plan items will be populated here -->
                        </div>
                        
                        <div class="border-t pt-3">
                            <div class="flex justify-between items-center text-sm text-gray-600">
                                <span>Total Items:</span>
                                <span id="total-items-count">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Summary -->
                    <div class="amount-card rounded-xl shadow-lg p-6 sticky top-28 animate-slide-up">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                            </svg>
                            Payment Summary
                        </h3>
                        
                        <div class="space-y-4 mb-6">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Annual Premium</span>
                                <span id="premium-total" class="font-semibold text-gray-800">₹0.00</span>
                            </div>
                            
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Platform Fee</span>
                                <span class="font-semibold text-gray-800">₹25</span>
                            </div>
                            
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">GST (18%)</span>
                                <span id="gst-amount" class="font-semibold text-gray-800">₹0.00</span>
                            </div>
                            
                            <hr class="border-gray-300">
                            
                            <div class="flex justify-between items-center text-lg">
                                <span class="font-bold text-gray-800">Total Amount</span>
                                <span id="total-amount" class="font-bold text-green-600">₹0.00</span>
                            </div>
                        </div>

                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-start">
                                <svg class="w-5 h-5 text-blue-600 mr-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <div>
                                    <p class="text-blue-800 font-medium text-sm">Secure Payment</p>
                                    <p class="text-blue-600 text-xs mt-1">Your payment information is encrypted and secure</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'https://zyva-healthcare-osrq.onrender.com'; // Change this to your deployed server URL
        // Global variables
        let finalTotal = 0;
        let planSummary = {};
        
        // ===== Auth helpers =====
        function getAuthToken() {
            return localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
        }
        
        function getCurrentUser() {
            const userStr = localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser');
            return userStr ? JSON.parse(userStr) : null;
        }
        
        function ensureLoggedIn() {
            const token = getAuthToken();
            const user = getCurrentUser();
            if (!token || !user) {
                alert('Please log in to continue to payment.');
                window.location.href = 'login_page.html';
                return false;
            }
            return true;
        }

        // Load plan summary and cart data from localStorage
        function loadPlanSummary() {
            planSummary.items = JSON.parse(localStorage.getItem('insuranceCart') || '[]');
            const premiumTotal = parseFloat(localStorage.getItem('insuranceTotal') || '0.00');
            
            // Display plan items
            const orderItemsList = document.getElementById('order-items-list');
            const totalItemsCount = document.getElementById('total-items-count');
            
            if (planSummary.items && planSummary.items.length > 0) {
                orderItemsList.innerHTML = '';
                planSummary.items.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'bg-gray-50 rounded-lg p-3 border border-gray-200';
                    itemDiv.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-800 text-sm">${item.name || 'Insurance Plan'}</h4>
                                <p class="text-xs text-gray-600 mt-1">${item.provider || 'Provider'}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold text-gray-800">₹${(item.premium || '0.00').toLocaleString('en-IN')}</p>
                            </div>
                        </div>
                    `;
                    orderItemsList.appendChild(itemDiv);
                });
                totalItemsCount.textContent = `${planSummary.items.length} plan(s)`;
            } else {
                orderItemsList.innerHTML = '<p class="text-center text-gray-500 text-sm">No plan selected</p>';
                totalItemsCount.textContent = '0 items';
            }
            
            // Calculate fees and totals
            const platformFee = 25;
            const subtotal = premiumTotal + platformFee;
            const gstAmount = Math.round(subtotal * 0.18);
            const totalAmount = subtotal + gstAmount;

            // Display amounts
            document.getElementById('premium-total').textContent = `₹${premiumTotal.toFixed(2)}`;
            document.getElementById('gst-amount').textContent = `₹${gstAmount}`;
            document.getElementById('total-amount').textContent = `₹${totalAmount}`;
            document.getElementById('pay-amount').textContent = `₹${totalAmount}`;
            
            return totalAmount;
        }

        // Initialize payment method selection
        function setupPaymentMethods() {
            const paymentCards = document.querySelectorAll('.payment-method-card');
            const paymentInputs = document.querySelectorAll('input[name="paymentMethod"]');
            
            paymentCards.forEach((card) => {
                card.addEventListener('click', () => {
                    // Remove selected class from all cards
                    paymentCards.forEach(c => c.classList.remove('selected'));
                    
                    // Add selected class to clicked card
                    card.classList.add('selected');
                    
                    // Check the corresponding radio button
                    const method = card.dataset.method;
                    document.querySelector(`input[value="${method}"]`).checked = true;
                    
                    showPaymentForm(method);
                });
            });

            paymentInputs.forEach(input => {
                input.addEventListener('change', (e) => {
                    showPaymentForm(e.target.value);
                });
            });
        }

        // Show/hide fields based on payment method
        function showPaymentForm(method) {
            // Hide all payment form sections
            document.querySelectorAll('.payment-form-section').forEach(section => {
                section.classList.remove('active');
            });

            // Show the selected payment form section
            const sectionId = `${method}-details`;
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.add('active');
            }
        }

        // Validate form based on payment method
        function validateForm(paymentMethod) {
            const requiredFields = ['user-name', 'user-email', 'user-phone'];
            let isValid = true;
            let errorMessage = '';

            // Check personal information
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    isValid = false;
                    field.classList.add('border-red-500');
                    if (!errorMessage) errorMessage = 'Please fill in all required personal information fields.';
                } else {
                    field.classList.remove('border-red-500');
                }
            });

            // Email validation
            const email = document.getElementById('user-email').value.trim();
            if (email && !email.includes('@')) {
                isValid = false;
                document.getElementById('user-email').classList.add('border-red-500');
                errorMessage = 'Please enter a valid email address.';
            }

            // Payment method specific validation
            if (paymentMethod === 'card') {
                const cardFields = ['card-number', 'card-expiry', 'card-cvv', 'card-name'];
                cardFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (!field.value.trim()) {
                        isValid = false;
                        field.classList.add('border-red-500');
                        if (!errorMessage) errorMessage = 'Please fill in all card details.';
                    } else {
                        field.classList.remove('border-red-500');
                    }
                });
            } else if (paymentMethod === 'upi') {
                const upiField = document.getElementById('upi-id');
                if (!upiField.value.trim()) {
                    isValid = false;
                    upiField.classList.add('border-red-500');
                    if (!errorMessage) errorMessage = 'Please enter your UPI ID.';
                } else {
                    upiField.classList.remove('border-red-500');
                }
            } else if (paymentMethod === 'netbanking') {
                const bankField = document.getElementById('bank-select');
                if (!bankField.value) {
                    isValid = false;
                    bankField.classList.add('border-red-500');
                    if (!errorMessage) errorMessage = 'Please select your bank.';
                } else {
                    bankField.classList.remove('border-red-500');
                }
            } else if (paymentMethod === 'wallet') {
                const walletSelected = document.querySelector('input[name="wallet-type"]:checked');
                if (!walletSelected) {
                    isValid = false;
                    if (!errorMessage) errorMessage = 'Please select a wallet type.';
                }
            }

            if (!isValid && errorMessage) {
                alert(errorMessage);
            }

            return isValid;
        }

        // Format card number input
        document.getElementById('card-number').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
            let formattedInputValue = value.match(/.{1,4}/g)?.join(' ') || '';
            if (formattedInputValue.length <= 19) {
                e.target.value = formattedInputValue;
            }
        });

        // Format expiry date input
        document.getElementById('card-expiry').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            e.target.value = value;
        });

        // Prefill user information
        function prefillUserInfo() {
            const user = getCurrentUser();
            if (!user) return;
            const nameInput = document.getElementById('user-name');
            const emailInput = document.getElementById('user-email');
            const phoneInput = document.getElementById('user-phone');
            const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim() || user.email || '';
            if (nameInput && !nameInput.value) nameInput.value = fullName;
            if (emailInput && !emailInput.value) emailInput.value = user.email || '';
            if (phoneInput && !phoneInput.value) phoneInput.value = user.phoneNumber || '';
        }

        // Handle form submission
        document.getElementById('payment-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!ensureLoggedIn()) return;

            const selectedPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;
            
            if (!selectedPaymentMethod) {
                alert('Please select a payment method');
                return;
            }

            // Validate form
            if (!validateForm(selectedPaymentMethod)) {
                return;
            }

            // Show loading overlay
            document.getElementById('loading-overlay').style.display = 'flex';

            try {
                // Prepare customer info
                const customerInfo = {
                    name: document.getElementById('user-name').value.trim(),
                    email: document.getElementById('user-email').value.trim(),
                    phone: document.getElementById('user-phone').value.trim()
                };

                // Prepare payment details based on method
                let paymentDetails = {};
                if (selectedPaymentMethod === 'card') {
                    const cardNumber = document.getElementById('card-number').value.replace(/\s/g, '');
                    paymentDetails = {
                        cardInfo: {
                            lastFourDigits: cardNumber.slice(-4),
                            cardholderName: document.getElementById('card-name').value.trim()
                        }
                    };
                } else if (selectedPaymentMethod === 'upi') {
                    paymentDetails = {
                        upiId: document.getElementById('upi-id').value.trim()
                    };
                } else if (selectedPaymentMethod === 'netbanking') {
                    paymentDetails = {
                        bankName: document.getElementById('bank-select').options[document.getElementById('bank-select').selectedIndex].text
                    };
                } else if (selectedPaymentMethod === 'wallet') {
                    const selectedWallet = document.querySelector('input[name="wallet-type"]:checked');
                    paymentDetails = {
                        walletType: selectedWallet ? selectedWallet.value : null
                    };
                }

                // Prepare order data
                const policyOrderData = {
                    customerInfo,
                    policies: planSummary.items || [],
                    paymentMethod: selectedPaymentMethod,
                    paymentDetails,
                    policySummary: {
                        premiumTotal: parseFloat(localStorage.getItem('insuranceTotal') || '0'),
                        platformFee: 25,
                        gstAmount: Math.round((parseFloat(localStorage.getItem('insuranceTotal') || '0') + 25) * 0.18),
                        totalAmount: finalTotal,
                        itemCount: planSummary.items ? planSummary.items.length : 0
                    }
                };

                // Send order to backend
                const response = await fetch(`${API_BASE_URL}/api/insurances`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify(policyOrderData)
                });

                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        localStorage.removeItem('authToken');
                        sessionStorage.removeItem('authToken');
                        alert('Your session has expired. Please log in again.');
                        window.location.href = 'login_page.html';
                        return;
                    }
                    let errorMsg = `HTTP error! Status: ${response.status}`;
                    try {
                        const errorResult = await response.json();
                        errorMsg = errorResult.error || errorMsg;
                    } catch (e) {
                        // Not a JSON error response.
                    }
                    throw new Error(errorMsg);
                }

                const result = await response.json();

                if (result.success) {
                    // Clear saved cart/order data after successful payment
                    localStorage.removeItem('insuranceTotal');
                    localStorage.removeItem('insuranceCart');

                    // Hide loading overlay
                    document.getElementById('loading-overlay').style.display = 'none';

                    // Show success message
                    const successOverlay = document.createElement('div');
                    successOverlay.className = 'fixed inset-0 flex flex-col items-center justify-center bg-white bg-opacity-95 z-50';
                    successOverlay.innerHTML = `
                        <div class="text-center p-8 bg-white rounded-lg shadow-2xl max-w-md mx-4">
                            <div class="mb-4">
                                <svg class="w-16 h-16 text-green-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                            <h2 class="text-2xl font-bold text-green-700 mb-2">Payment Successful!</h2>
                            <p class="text-gray-600 mb-2">Policy ID: ${result.policyId}</p>
                            <p class="text-gray-600 mb-4">Transaction ID: ${result.transactionId}</p>
                            <p class="text-blue-700 text-lg mb-4">Policy purchase confirmed for ${policyOrderData.policySummary.itemCount} plan${policyOrderData.policySummary.itemCount !== 1 ? 's' : ''}</p>
                            <p class="text-blue-700 mb-4">Redirecting to your policies page...</p>
                            <div class="mx-auto w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                        </div>
                    `;
                    document.body.appendChild(successOverlay);

                    // Redirect after 3 seconds
                    setTimeout(() => {
                        window.location.href = "my_insurance.html";
                    }, 1000);
                } else {
                    throw new Error(result.error || 'Payment failed');
                }
            } catch (error) {
                // Hide loading overlay
                document.getElementById('loading-overlay').style.display = 'none';
                
                console.error('Payment error:', error);
                alert('Payment failed: ' + (error.message || 'Please try again'));
            }
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            if (!ensureLoggedIn()) return;
            prefillUserInfo();
            finalTotal = loadPlanSummary();
            setupPaymentMethods();
        });
    </script>
    <script src="auth.js"></script>

    <footer class="py-6 flex-grow bottom-0 left-0 w-full">
        <div class="text-center text-sm">© 2025 ZYVA Healthcare. All rights reserved to ZYVA.</div>
    </footer>
</body>
</html>
